#include "types.h"
#include "constants.h"
#include "intrinsics.h"
#include "natives.h"
#include "common.h"
#include "gtac.h"
#include "util.h"

global(65043) uint g_ParkedCars[11];

void CreateDefaultObjects()
{
	// Church door 1
	Object Object1;
	CREATE_OBJECT_NO_OFFSET(1845915705, -281.06440000, -283.70000000, 15.87640000, &Object1, 0);
	SET_OBJECT_HEADING(Object1, 90.00000000);
	FREEZE_OBJECT_POSITION(Object1, 1);

	// Church door 2
	Object Object2;
	CREATE_OBJECT_NO_OFFSET(-631715616, -281.06440000, -280.70640000, 15.87640000, &Object2, 0);
	SET_OBJECT_HEADING(Object2, 90.00000000);
	FREEZE_OBJECT_POSITION(Object2, 1);

	// Bruice's door
	Object Object3;
	CREATE_OBJECT_NO_OFFSET(639246688, 864.32000000, -121.64500000, 7.40000000, &Object3, 0);
	SET_OBJECT_HEADING(Object3, 90.00000000);
	SET_OBJECT_DYNAMIC(Object3, 0);
	FREEZE_OBJECT_POSITION(Object3, 1);

	// Museum
	Object Object4;
	CREATE_OBJECT_NO_OFFSET(1312423945, -123.72640000, 772.02260000, 35.05130000, &Object4, 0);
	SET_OBJECT_COORDINATES(Object4, -123.72640000, 772.02260000, 35.05130000);
	SET_OBJECT_HEADING(Object4, 0.00000000);
	SET_OBJECT_DYNAMIC(Object4, 0);
	FREEZE_OBJECT_POSITION(Object4, 1);

	if (GET_NUMBER_OF_INSTANCES_OF_STREAMED_SCRIPT("coop_swatasslt") == 0)
	{
		// Petrovic's plane
		Object Object5;
		CREATE_OBJECT_NO_OFFSET(223915744, 2394.49600000, 175.89900000, 5.85800000, &Object5, 0);
		SET_OBJECT_ROTATION(Object5, 0.00000000, 235.00000000, 240.37500000);
		SET_OBJECT_DYNAMIC(Object5, 0);
		FREEZE_OBJECT_POSITION(Object5, 1);
	}
	return;
}

void CheckForJoiningPlayers()
{
	for (int I = 0; I < 32; I++)
	{
		if (PLAYER_WANTS_TO_JOIN_NETWORK_GAME(I))
		{
			TELL_NET_PLAYER_TO_START_PLAYING(I, 0);
		}
	}
}

Blip CreatePlayerBlip(int I)
{
	Blip pBlip;
	ADD_BLIP_FOR_CHAR(GetPlayerCharFromIndex(I), &pBlip);
	int r, g, b;
	GET_PLAYER_RGB_COLOUR(GetPlayerFromIndex(I), &r, &g, &b);
	CHANGE_BLIP_COLOUR(pBlip, (((r * 16777216) + (g * 65536)) + (b * 256)) + 255);
	CHANGE_BLIP_PRIORITY(pBlip, 3);
	CHANGE_BLIP_SCALE(pBlip, 0.60000000);
	if (!IS_JAPANESE_VERSION())
		CHANGE_BLIP_NAME_FROM_ASCII(pBlip, GET_PLAYER_NAME(GetPlayerFromIndex(I)));
	else
		CHANGE_BLIP_NAME_TO_PLAYER_NAME(pBlip, GetPlayerFromIndex(I));
	CHANGE_BLIP_DISPLAY(pBlip, 2 );
	return pBlip;
}

void ProcessBlips(Blip* prgBlips)
{
	for (int I = 0; I < 32; I++)
	{
		if (I != GET_PLAYER_ID() && IS_NETWORK_PLAYER_ACTIVE(GetPlayerFromIndex(I)) && IS_PLAYER_SCRIPT_CONTROL_ON(GetPlayerFromIndex(I)) && !IS_CHAR_DEAD(GetPlayerCharFromIndex(I)))
		{
			if (!DOES_BLIP_EXIST(prgBlips[I]))
			{
				prgBlips[I] = CreatePlayerBlip(I);
			}
		}
		else
		{
			if (DOES_BLIP_EXIST(prgBlips[I]))
			{
				REMOVE_BLIP(prgBlips[I]);
				prgBlips[I] = 0;
			}
		}
	}
}

int GetDeadDelay(int i)
{
	switch (i)
	{
		case 0: return 1000;
		case 1: return 5000;
		case 2: return 10000;
		case 3: return 15000;
		case 4: return 20000;
		case 5: return 25000;
		case 6: return 30000;
	}
	return 1000;
}

extern void Respawn();

void CheckImDead()
{
	if (IS_NETWORK_PLAYER_ACTIVE(GET_PLAYER_ID()))
	{
		if (HOW_LONG_HAS_NETWORK_PLAYER_BEEN_DEAD_FOR(GET_PLAYER_ID()) > GetDeadDelay(1) && !IS_PAUSE_MENU_ACTIVE())
		{
			if (IS_SCREEN_FADED_OUT())
			{
				Respawn();
			}
			else if (!IS_SCREEN_FADING_OUT())
			{
				DO_SCREEN_FADE_OUT(500);
			}
		}
	}
}

void ManageNetworkGame(Blip* prgBlips)
{
	if (BeginServerCode())
	{
		CheckForJoiningPlayers();

		EndServerCode();
	}

	ProcessBlips(prgBlips);
	CheckImDead();
}

void UpdatePlayerWeapons(Ped ped)
{
	UpdateWeaponOfPed(ped, WEAPON_KNIFE);
	UpdateWeaponOfPed(ped, WEAPON_MOLOTOV);
	UpdateWeaponOfPed(ped, WEAPON_DEAGLE);
	UpdateWeaponOfPed(ped, WEAPON_SHOTGUN);
	UpdateWeaponOfPed(ped, WEAPON_MP5);
	UpdateWeaponOfPed(ped, WEAPON_AK47);
}

void Respawn()
{
	REQUEST_MODEL(GetWeaponTypeModel(3));

	SetPlayerEnabled(GET_PLAYER_ID(), false);
	REQUEST_COLLISION_AT_POSN(-612.159f, -933.031f, 4.842f);
	RESURRECT_NETWORK_PLAYER(GET_PLAYER_ID(), -612.159f, -933.031f, 4.842f, 0);
	CLEAR_CHAR_TASKS_IMMEDIATELY(GetPlayerChar());
	SET_CHAR_HEALTH(GetPlayerChar(), 300);
	REMOVE_ALL_CHAR_WEAPONS(GetPlayerChar());
	CLEAR_WANTED_LEVEL(GetPlayer());
	SET_CHAR_CAN_BE_KNOCKED_OFF_BIKE(GetPlayerChar(), false);
	SET_CHAR_WILL_FLY_THROUGH_WINDSCREEN(GetPlayerChar(), false);
	SET_PLAYER_NEVER_GETS_TIRED(GetPlayerIndex(), true);
	SET_GAME_CAM_HEADING(0.0f);

	GIVE_WEAPON_TO_CHAR(GetPlayerChar(), 3, 1, 0);

	UpdatePlayerWeapons(GetPlayerChar());

	MARK_MODEL_AS_NO_LONGER_NEEDED(GetWeaponTypeModel(3));

	SET_CAR_DENSITY_MULTIPLIER(1.0f);
	SET_RANDOM_CAR_DENSITY_MULTIPLIER(1.0f);
	SET_PARKED_CAR_DENSITY_MULTIPLIER(1.0f);
	SET_REDUCE_VEHICLE_MODEL_BUDGET(0);

	SET_PED_DENSITY_MULTIPLIER(1.0f);
	SET_SCENARIO_PED_DENSITY_MULTIPLIER(1.0f, 1.0f);
	SET_REDUCE_PED_MODEL_BUDGET(0);

	SetPlayerEnabled(GET_PLAYER_ID(), true);

	FORCE_LOADING_SCREEN(FALSE);
	if (!IS_SCREEN_FADED_IN())
		DO_SCREEN_FADE_IN(500);
}

void InGame()
{
	DISABLE_CAR_GENERATORS(0, 0);
	FORCE_GENERATE_PARKED_CARS_TOO_CLOSE_TO_OTHERS(0);

	SET_ROCKET_LAUNCHER_FREEBIE_IN_HELI(1);
	USE_PLAYER_COLOUR_INSTEAD_OF_TEAM_COLOUR(1);

	SET_NO_RESPRAYS(0);

	SET_MONEY_CARRIED_BY_ALL_NEW_PEDS(0);
	SET_PLAYERS_DROP_MONEY_IN_NETWORK_GAME(0);

	SET_MAX_WANTED_LEVEL(6);
	SET_WANTED_MULTIPLIER(1.0);
	SET_CREATE_RANDOM_COPS(1);
	SET_DITCH_POLICE_MODELS(0);

	REMOVE_ALL_PICKUPS_OF_TYPE(23);

	/*Blip pBlip;
	ADD_BLIP_FOR_COORD(-1147.96900000, 1176.36600000, 15.83930000, &pBlip);
	SET_BLIP_AS_SHORT_RANGE(pBlip, 1);
	CHANGE_BLIP_SPRITE(pBlip, 75);
	CHANGE_BLIP_SCALE(pBlip, 0.75000000);
	CHANGE_BLIP_PRIORITY(pBlip, 0);

	ADD_BLIP_FOR_COORD(-1300.05800000, 274.11460000, 9.79920000, &pBlip);
	SET_BLIP_AS_SHORT_RANGE(pBlip, 1);
	CHANGE_BLIP_SPRITE(pBlip, 75);
	CHANGE_BLIP_SCALE(pBlip, 0.75000000);
	CHANGE_BLIP_PRIORITY(pBlip, 0);

	ADD_BLIP_FOR_COORD(-307.26430000, 1549.11400000, 19.26490000, &pBlip);
	SET_BLIP_AS_SHORT_RANGE(pBlip, 1);
	CHANGE_BLIP_SPRITE(pBlip, 75);
	CHANGE_BLIP_SCALE(pBlip, 0.75000000);
	CHANGE_BLIP_PRIORITY(pBlip, 0);

	ADD_BLIP_FOR_COORD(-507.40950000, 375.76670000, 5.66290000, &pBlip);
	SET_BLIP_AS_SHORT_RANGE(pBlip, 1);
	CHANGE_BLIP_SPRITE(pBlip, 75);
	CHANGE_BLIP_SCALE(pBlip, 0.75000000);
	CHANGE_BLIP_PRIORITY(pBlip, 0);

	ADD_BLIP_FOR_COORD(1058.17900000, -287.15700000, 20.33040000, &pBlip);
	SET_BLIP_AS_SHORT_RANGE(pBlip, 1);
	CHANGE_BLIP_SPRITE(pBlip, 75);
	CHANGE_BLIP_SCALE(pBlip, 0.75000000);
	CHANGE_BLIP_PRIORITY(pBlip, 0);*/

	REQUEST_MODEL(PED_F_Y_SOCIALITE);
	while (!HAS_MODEL_LOADED(PED_F_Y_SOCIALITE)) WAIT(0);
	CHANGE_PLAYER_MODEL(GetPlayerIndex(), PED_F_Y_SOCIALITE);
	MARK_MODEL_AS_NO_LONGER_NEEDED(PED_F_Y_SOCIALITE);

	Respawn();

	ADD_SCORE(GetPlayer(), 100000);
}

void main()
{
	SET_MISSION_FLAG(true);
	ALLOW_THIS_SCRIPT_TO_BE_PAUSED(false);
	SET_GLOBAL_INSTANCE_PRIORITY(2);
	UNLOCK_LAZLOW_STATION();
	FORCE_NEXT_STATION_LAZLOW(false);
	ALLOW_GAME_TO_PAUSE_FOR_STREAMING(true);
	SET_MAX_WANTED_LEVEL(6);
	SET_WANTED_MULTIPLIER(1.0f);
	SET_CREATE_RANDOM_COPS(true);
	SET_DITCH_POLICE_MODELS(false);
	DISPLAY_PLAYER_NAMES(true);
	NETWORK_SET_HEALTH_RETICULE_OPTION(true);

	//for (int i = 0; i < 11; i++)
	//{
	//	SWITCH_CAR_GENERATOR(g_ParkedCars[i], 101);
	//}

	// Disable traffic at the airpot (it looks wrong in mp)
	SWITCH_ROADS_OFF( 2351.24100000, 72.54793000, 2.29722600, 2227.93300000, 57.00667000, 17.17584000 );
	SWITCH_ROADS_OFF( 2227.93300000, 57.00667000, 17.17584000, 2116.49400000, 94.63986000, 3.83257800 );
	SWITCH_ROADS_OFF( 2116.49400000, 94.63986000, 3.83257800, 2134.08900000, 147.54960000, 13.00724000 );
	SWITCH_ROADS_OFF( 2351.24100000, 72.54793000, 2.29722600, 2367.59900000, 146.75340000, 13.58018000 );
	SWITCH_ROADS_OFF( 2398.44000000, 263.93030000, 3.03577000, 2425.46400000, 229.44690000, 14.43351000 );
	SWITCH_ROADS_OFF( 2463.91400000, 166.82880000, -6.62922700, 2385.22100000, 263.26900000, 22.66073000 );

	// Just to be safe
	FLUSH_SCENARIO_BLOCKING_AREAS();

	// Prison
	//ADD_SCENARIO_BLOCKING_AREA(-1184.82500000, -502.39840000, 0.40637700, -895.27470000, -320.98380000, 22.06192000);

	// Airport
	//ADD_SCENARIO_BLOCKING_AREA(2047.14200000, 36.41048000, -8.88823000, 2852.10400000, 880.11010000, 36.31237000);

	// Ferries
	//ADD_SCENARIO_BLOCKING_AREA(-1180, 470, 0, -1050, 630, 15);

	// Happiness island
	//ADD_SCENARIO_BLOCKING_AREA(-415, -999, 0, -400, -980, 15);

	{
		ALLOCATE_SCRIPT_TO_OBJECT("puzzle_launcher", 691499124, 100, 10.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("puzzle_launcher", -386570734, 100, 10.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("bowl_trigger", 1071999466, 100, 25.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("darts_launcher", 33267265, 100, 50.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ATMobj", 943099328, 100, 30.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ATMobj", 1646518682, 100, 30.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ATMobj", -1707894766, 100, 30.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("CarWash", -582605513, 100, 50.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("ambBarrier", 21350196, 100, 100.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("till", -1321409645, 100, 100.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("vendor", 526100790, 100, 80.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("vendor", 1914818237, 100, 80.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("vendor", 1139438163, 100, 80.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("burgerVendor", 381327348, 100, 80.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("nutVendor", 1179300952, 100, 80.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("magVendor", -2047685421, 100, 80.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("magVendor", -1654925163, 100, 80.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("telescope", -1028473, 100, 2.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("sprunk", -2033273140, 100, 50.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("sprunk", -1702863313, 100, 50.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("computerStreamed", -1699088948, 100, 3.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("computerStreamed", -1185959097, 100, 3.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("computerStreamed", -805425417, 100, 5.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("pool_table", -1693860173, 100, 50.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("pool_table", 1823613694, 100, 50.00000000, -1);
		//ALLOCATE_SCRIPT_TO_OBJECT("pool_table", -1570172664, 100, 50.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambTV", -1618524073, 100, 80.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambTV", -1058927856, 100, 80.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambTV", 1243139908, 100, 80.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambTV", 900769396, 100, 80.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambTV", -1336305346, 100, 80.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambClubLights", 1005973733, 100, 50.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambClubLights", 1781111577, 100, 50.00000000, -1);
		ALLOCATE_SCRIPT_TO_OBJECT("ambClubLights", -21824081, 100, 50.00000000, -1);

		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambATMQ", 50.00000000);
		REGISTER_WORLD_POINT_SCRIPT_BRAIN("EmpireTelescope", 80.00000000);
		REGISTER_WORLD_POINT_SCRIPT_BRAIN("EmpireDown", 80.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambTaxiHail", 50.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("copbootsearch", 80.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambgerry3doorlock", 5.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambSaveBed", 50.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambWardrobe", 25.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambnightclubext", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("gunLockup", 95.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("gunLockupCT", 150.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambBar", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("TollBooth", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambBridgePatrol", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambTunnelCops", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambHotel", 50.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("foodServer", 80.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambInternetCafe", 50.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambCabaret", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambCargoHoldDoors", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambJerseyDocksGates", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambBouncer", 150.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambStripClub", 60.00000000);
		//ALLOCATE_SCRIPT_TO_OBJECT("ambPoleDancer", -132862690, 100, 50.00000000, -1);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambComedyClub", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambHomelandCordon", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambChurchDoors", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambLiftDoors", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambToiletDoors", 25.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambJimsLocks", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambtaxdpt", 50.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambPolRdBlk", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("Ambblkhawk", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambhelicopter", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("Manhat_heli_tours", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("binco_brook_s", 75.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("perseus_manhat_8", 75.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("modo_manhat_5", 75.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("AmbWindowLift", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("bowling_lane", 100.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambAirpotarea", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambUNarea", 200.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("ambShowroom", 75.00000000);
		//REGISTER_WORLD_POINT_SCRIPT_BRAIN("cablecars", 75.00000000);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("garbage_trucks", 1136499716, 100, 0);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambbeggar", -1080673049, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambbeggar", -1827421800, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambbeggar", -142386662, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambpimpnpros", 552542187, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambpimpnpros", 996267216, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambdealer", 1448755353, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambpreacher", 495499562, 100, 1);
		//ALLOCATE_SCRIPT_TO_RANDOM_PED("ambpreacher", 379171768, 100, 1);
		ALLOCATE_SCRIPT_TO_RANDOM_PED("ambbusker", -1188246269, 100, 1);
	}

	LOAD_ALL_PATH_NODES(1);
	FLUSH_ALL_SPAWN_BLOCKING_AREAS();
	CreateDefaultObjects();
	SWITCH_ARROW_ABOVE_BLIPPED_PICKUPS(1);
	REGISTER_SCRIPT_WITH_AUDIO(1);
	SET_ROCKET_LAUNCHER_FREEBIE_IN_HELI(1);
	USE_PLAYER_COLOUR_INSTEAD_OF_TEAM_COLOUR(1);

	if (!IS_CHAR_DEAD(GetPlayerChar()))
		SetPlayerEnabled(GET_PLAYER_ID(), false);

	SET_CAR_DENSITY_MULTIPLIER(0.0f);
	SET_PED_DENSITY_MULTIPLIER(0.0f);

	NETWORK_SET_SCRIPT_LOBBY_STATE(0);

	if (BeginServerCode())
	{
		SET_SYNC_WEATHER_AND_GAME_TIME(false);

		if (!NETWORK_IS_SESSION_STARTED())
		{
			NETWORK_START_SESSION();
			while (NETWORK_START_SESSION_PENDING())
				WAIT(0);
		}

		EndServerCode();
	}

	WAIT(0);

	FORCE_LOADING_SCREEN(FALSE);

	InGame();

	Blip PlayerBlips[32] = { 0 };

	while (true)
	{
		WAIT(0);

		ManageNetworkGame(PlayerBlips);

		if (!IS_NETWORK_GAME_RUNNING())
		{
			if (!LOCAL_PLAYER_IS_READY_TO_START_PLAYING())
			{
				SHUTDOWN_AND_LAUNCH_SINGLE_PLAYER_GAME();
				TERMINATE_THIS_SCRIPT();
			}
		}

		if (LOCAL_PLAYER_IS_READY_TO_START_PLAYING())
			LAUNCH_LOCAL_PLAYER_IN_NETWORK_GAME();
	}

	TERMINATE_THIS_SCRIPT();
}
